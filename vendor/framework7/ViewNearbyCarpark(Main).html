<!DOCTYPE html>
<html>
<head>

	<!-- Your app title -->
	<title>Carpark Tracking</title>

	<!-- Path to Framework7 iOS CSS theme styles-->
	<link rel="stylesheet" href="dist/css/framework7.ios.min.css">
	<!-- Path to Framework7 iOS related color styles -->
	<link rel="stylesheet" href="dist/css/framework7.ios.colors.min.css">
	<!-- Path to Framework7 icons-->
	<link rel="stylesheet" href="dist/css/framework7-icons.css">


	<!-- Custom css -->
	<style>

		#map-container { height: 100%} /*Change Google map Height here*/

		.popover {width: 250px;}

		.pac-container{
			z-index: 20000;
			display: inline;
		}
		/* Default Status bar background */
		.statusbar-overlay {
			background: pink;
			/* We can add transition for smooth color animation */
			-webkit-transition: 400ms;
			transition: 400ms;
		}

		/* Change Status bar background when panel opened */
		body.with-panel-left-cover .statusbar-overlay {
			background: #222;
		}

		.picker-modal{
			height:40%;
		}

		.button .active .new{
			bottom:10% !important;
			left:90% !important;
			position:absolute !important;
		}

	</style>

	<!-- Google map JS -->
	<script type="text/javascript" src="dist/js/framework7.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
<div class = "views">
	<div class = "view view-main">
		<div class="pages">
			<div data-page = "home" class = "page navbar-fixed">
				<div class="statusbar-overlay"></div>
				<div id="pac-card" class="navbar">
					<div class="navbar-inner" style="padding:0;">

						<a href="#" data-popover=".popover-links" class="link open-popover"  style="margin-left:10px;"><i class="icon icon-bars size-20"></i>&nbsp&nbsp</a>
						<form class="searchbar">
							<div class="searchbar-input">
								<input id="searchBox" type="search" placeholder="Search" >
								<a href="#" class="searchbar-clear"></a>
							</div>
							<a href="#" class="searchbar-cancel">Cancel</a>
						</form>
					</div>
				</div>

				<div class="page-content">
					<div id="map-container" style="height:100%"></div>
					<a href="#plan_route" style="right:3%; bottom:3%;" class="floating-button color-blue">
						GO
					</a>
					<a href="#" id="clearBtn" onclick="resetRoute()" style="left:3%; bottom:3%; display:none;" class="floating-button color-red">Clear</a>
				</div>
			</div>

			<!--Plan Route-->
			<div data-page="plan_route"class="page cached">
				<div class="navbar">
					<div class="navbar-inner" style="padding:0;">
						<div class="left">
							<a href="#home" class="link icon-only back">
								<i class="icon icon-back"></i>&nbsp&nbsp</a>
						</div>
						<div class="center sliding">
							Plan Route
						</div>
					</div>
				</div>

				<div class="page-content">
					<form class="searchbar searchbar-init" style="margin-top:45px">
						<div class="searchbar-input" >
							<input id="source" type="search" placeholder="Start" >
							<a href="#" class="searchbar-clear"></a>
						</div>
					</form>
					<br>
					<form class="searchbar searchbar-init">
						<div class="searchbar-input">
							<input id="destination" type="search" placeholder="Destination" >
							<a href="#" class="searchbar-clear"></a>
						</div>
					</form>
					<a href="#home" onclick="route()" class="button button-big button-round active">Plan Route</a>
				</div>
			</div>

			<!-- DisplayCP -->

			<div data-page="displayCP" class="page cached">

				<div class="navbar">
					<div class="navbar-inner">
						<!-- We need cool sliding animation on title element, so we have additional "sliding" class -->
						<div class="left">
							<a href="#home" class="link icon-only back">
								<i class="icon icon-back"></i>
							</a>
						</div>

						<div class="center sliding" id="displayCPname">~CarparkNameHere~</div>

						<div class="right">

							<label class="label-checkbox item-content">
								<input type="checkbox" name="my-checkbox" value="Movies">
								<div class="item-media">
									<i class="icon icon-form-checkbox"></i>
								</div>
							</label>

						</div>

					</div>
				</div>

				<!-- Scrollable page content -->
				<div class="page-content">
					<div class="content-block-title">Carpark Details:</div>
					<div class="list-block">
						<ul>
							<li class="item-content">
								<div class="item-inner">
									<div class="item-title">Name:</div>
									<div class="item-after resizable">~Carpark Name~</div>
								</div>
							</li>
							<li class="item-content">
								<div class="item-inner">
									<div class="item-title">Address</div>
									<div class="item-after">~Carpark Address~</div>
								</div>
							</li>
							<li class="item-content">
								<div class="item-inner">
									<div class="item-title">Available Lots:</div>
									<div class="item-after"><span class="badge">5</span></div>
								</div>
							</li>
						</ul>
					</div>

					<div class="content-block-title">Weekday Fees:</div>
					<div class="list-block">
						<ul>
							<li class="item-content">
								<div class="item-inner">
									~$00.00~ for first half hour
								</div>
							</li>
							<li class="item-content">
								<div class="item-inner">
									~$00.00~ for first half hour
								</div>
							</li>
						</ul>
					</div>

					<div class="content-block-title">Weekend Fees:</div>
					<div class="list-block">
						<ul>
							<li class="item-content">
								<div class="item-inner">
									~$00.00~ for first half hour
								</div>
							</li>
							<li class="item-content">
								<div class="item-inner">
									~$00.00~ for first half hour
								</div>
							</li>
						</ul>
					</div>

					<div class="content-block-title">Calculate Fees:</div>
					<div class="list-block">
						<div class="item-input">
							<div class="range-slider" style="width: 80%;margin-left: 10%;margin-top:15px; margin-bottom: 15px;">
								<input type="range" min="1" max="100" step="1" class="">
							</div>
						</div>
						<ul>
							<li class="item-content">
								<div class="item-inner">
									<div class="item-title">Total Time::</div>
									<div class="item-after resizable">~HH:MM~</div>
								</div>
							</li>
							<li class="item-content">
								<div class="item-inner">
									<div class="item-title">Total Fees:</div>
									<div class="item-after">~$100.000~</div>
								</div>
							</li>
						</ul>
					</div>

					<div style="padding: 0 5px;">
						<div class="row">
							<div class="col-50">
								<a href="#" class="button button-big button-red">Plan Route</a>
							</div>
							<div class="col-50">
								<a href="#" class="button button-big button-green">Feedback</a>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- RecordCPInfo -->

			<div data-page="recordCP" class="page cached">
				<div class="navbar">
					<div class="navbar-inner">
						<!-- We need cool sliding animation on title element, so we have additional "sliding" class -->
						<div class="left">
							<a href="#home" class="link icon-only back">
								<i class="icon icon-back "></i>
							</a>
						</div>

						<div class="center sliding">Record Carpark Lot Information</div>

					</div>
				</div>
				<!-- Scrollable page content -->
				<div class="page-content">
					<div class="content-block-title">Select Carpark:</div>
					<div class="list-block">
						<ul>
							<li class="item-content">
								<div class="item-inner" style="width: 60%;">
									<p style="margin:auto; width:100%; text-align:left;" id="xferback"></p>
								</div>
								<div class="item-inner" style="width: 40%; margin:0 auto;">

									<!-- <a href="#" data-picker=".picker-1" class="open-picker">Open Picker</a> -->
									<!-- <a href="#search" style="margin-left: auto">Search</a> -->
									<a href="#search" style="margin-left: auto">Search</a>
								</div>
							</li>
						</ul>
					</div>
					<!-- Picker -->
					<div class="picker-modal picker-1">
						<div class="toolbar">
							<div class="toolbar-inner">
								<div class="left"></div>
								<div class="right"><a href="#" class="close-picker">Done</a></div>
							</div>
						</div>
						<div class="picker-modal-inner">
							<div class="content-block">
								<h4>Info 1</h4>
								<p>Lorem ipsum dolor...</p>
							</div>
						</div>
					</div>

					<div class="content-block-title">Carpark Lot Picture:</div>
					<div class="swiper-container swiper-1">
						<div class="swiper-pagination"></div>
						<div class="swiper-wrapper">
							<div class="swiper-slide"><img src="dist\noimage.png" style="width:90%; border-style:solid; border-radius: 5px; margin-left:5%;"></div>
						</div>
					</div>

					<div class="row center">
						<div class="col-70" style="margin:0 auto;">
							<a href="#" class="button button-big button-red" disabled>No Camera Detected</a>
						</div>
					</div>

					<div class="content-block-title">Time Elapsed:</div>
					<div class="list-block">
						<ul>
							<li class="item-content">
								<div class="item-inner" style="width: 60%;">
									<p style="margin:auto; width:100%; text-align:left;" id="timer">Press to start!</p>
								</div>
								<div class="item-inner" style="width: 40%; margin:0 auto;">
									<a href="#" onClick="starttimer()" style="margin-left: auto">Reset Time</a>
								</div>
							</li>
							<li class="item-content">
								<div class="item-inner">
									<div class="item-title">Current Fees:</div>
									<div class="item-after resizable"  id="fee">$0.00</div>
								</div>
							</li>
						</ul>
					</div>

					<div class="content-block-title">Additional Details:</div>
					<div class="list-block" style="margin-bottom:5px;">
						<ul>
							<li class="item-content">
								<div class="item-content" style="width: 100%; padding: 0px;">
									<div class="item-inner" style="padding: 0px;>
							  <div class="item-input">
									<textarea class="resizable"></textarea>
								</div>
					</div>
				</div>
				</li>
				</ul>
				<!-- <div class="row center"> -->
				<!-- <div class="col-70" style="margin:0 auto;"> -->
				<!-- <a href="#" class="button button-big button-red">Save Additional Details</a> -->
				<!-- </div> -->
				<!-- </div> -->
			</div>
		</div>

		<div class="page cached" data-page="search">


			<!-- Search Bar overlay -->
			<div class="searchbar-overlay"></div>

			<div class="page-content"style="padding-top:0px;">
				<div class="navbar" >
					<div class="navbar-inner">
						<!-- We need cool sliding animation on title element, so we have additional "sliding" class -->
						<div class="left">
							<a href="#recordCP" class="link icon-only back">
								<i class="icon icon-back"></i>
							</a>
						</div>
						<div class="center sliding">Search Carpark</div>
					</div>
				</div>
				<form data-search-list=".list-block-search" data-search-in=".item-title" class="searchbar searchbar-init">
					<div class="searchbar-input">
						<input type="search" placeholder="Search" id="searchform" onchange="initService();">
					</div>
				</form>
				<!-- <div class="content-block searchbar-not-found" style="margin-top:45px;"> -->
				<!-- <div class="content-block-inner">Nothing found</div> -->
				<!-- </div> -->

				<!-- This block will be displayed if anything found, and this list block is used a searbar target -->

				<div class="list-block list-block-search" style="margin-top:0px;">
					<ul id="testingsearch">


					</ul>
				</div>

			</div>
		</div>
	</div>
</div>
</div>

<!-- Links popover -->
<div class="popover popover-links">
	<div class="popover-angle"></div>
	<div class="popover-inner">
		<div class="list-block">
			<ul>
				<li><a href="#recordCP" class="list-button item-link">Record Lot Information</a></li>
				<li><a href="#" class="list-button item-link">Submit Feedback</a></li>
				<li><a href="#" class="list-button item-link">Quit</a></li>
			</ul>
		</div>
	</div>
</div>

<!-- Patht to Framework7 Library JS: required for js itnerativity-->
<script type = "text/javascript"
		src = "dist/js/framework7.min.js"></script>
<script type="text/javascript" src="dist/carparks.json"></script>
<script>
    var myApp = new Framework7();
    var mainView = myApp.addView('.view-main',{
        domCache: true // enable inline pages
    });
    var map_contain = document.getElementById("map-container");

    // carpark data demo array for autocompelte
    var fruits = ('Apple Apricot Avocado Banana Melon Orange Peach Pear Pineapple').split(' ');
    var mySearchbar = myApp.searchbar('.searchbar', {
        customSearch: true,
    });
    //    var autocompleteDropdownSimple = myApp.autocomplete({
    //        input: '#searchBox',
    //        openIn: 'dropdown',
    //        source: function (autocomplete, query, render) {
    //            var results = [];
    //            if (query.length === 0) {
    //                render(results);
    //                return;
    //            }
    //            // Find matched items
    //            for (var i = 0; i < fruits.length; i++) {
    //                if (fruits[i].toLowerCase().indexOf(query.toLowerCase()) >= 0) results.push(fruits[i]);
    //            }
    //            // Render items by passing array with result items
    //            render(results);
    //        }
    //    });
    var autocomplete, map;
    var markers = [];
    var directionsService, directionsDisplay;
    function initMap() {
        map = new google.maps.Map(document.getElementById('map-container'), {
            center: {lat: 1.3521, lng: 103.81985},
            zoom: 11
        });
        directionsDisplay = new google.maps.DirectionsRenderer;
        directionsService = new google.maps.DirectionsService;
        directionsDisplay.setMap(map);

        // Create the search box and link it to the UI element.
        var input = document.getElementById('searchBox');
        var startInput = document.getElementById('source');
        var destinationInput = document.getElementById('destination');
        var searchBox = new google.maps.places.SearchBox(input);
        var start = new google.maps.places.SearchBox(startInput);
        var destination = new google.maps.places.SearchBox(destinationInput);

//        // Bias the SearchBox results towards current map's viewport.
//        map.addListener('bounds_changed', function() {
//          searchBox.setBounds(map.getBounds());
//        });
        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        var marker, carpark, location
        for (name in json) {
            carpark = json[name];
            if(carpark["GPS"]!=null){
                var image = {
                  url: 'dist/carpark_green.png',
                  //size: new google.maps.Size(100, 100),
                  // The origin for this image is (0, 0).
                  origin: new google.maps.Point(0, 0),
                  // The anchor with respect to the Lat and Long
                  anchor: new google.maps.Point(15, 15)
                };
				marker = new google.maps.Marker({
					map: map,
					icon: image,
					title: name,
					position: new google.maps.LatLng(carpark['GPS']['Lat'], carpark['GPS']['Long'])
				});
				marker.addListener('click', function(){
					var carpark = json[this.title];
					console.log(this.title)
					console.log(carpark);
					// Check first, if we already have opened picker
					if ($('.picker-modal.modal-in').length > 0) {
						myApp.closeModal('.picker-modal.modal-in');
					}

					var modelText=
						'<div class="picker-modal"  style="background-color:white">' +
							'<div class="picker-modal-inner">' +
								'<div class="toolbar" style="background-color:#007aff">' +
									'<div class="toolbar-inner">' +
										'<div class="left"></div>' +
										'<div class="right"><a href="#" class="link close-picker" style="color:white;">Done</a></div>\n' +
									'</div>' +
								'</div>' +
								'<div class="content-block left">' +
									'<h5 class="content-block-title">'+ this.title+" Carpark</h5>";
									//There is a Weekday Rate
									if(carpark['Rates']['Weekday']!=null){
									    var weekday = carpark['Rates']['Weekday'];
										modelText+="<u>Weekday Rates</u><br>";
										for(rate in weekday){
										    var start = new Date()
											modelText+="Start :"+weekday[rate]['startHour']+"00 - "+weekday[rate]['endHour']+"00 (";
											var prices = weekday[rate]['pricePerHalfHour'];
											//per entry display
											if(prices[1]==0)
											    modelText += "Per Entry:$"+prices[0]+")<br>";
											else{
											    //1St Hour and subsequent Hour
											    if(prices.length>2){
											       var prev = prices[0];
													for(var i=1;i<prices.length;i++){
														if(prices[i]!=prev){
															modelText += "Price 1st h: $"+prev*2;
															prev = prices[i];
														}
													}
													modelText += " Subsequent 1/2 h: $"+prev+")<br>";
												}
											    else{
													modelText += " Price per 1/2 h: $"+prices[0]+")<br>";
												}
											}
										}
									}
									//There is a Saturday Rate
									if(carpark['Rates']['Saturday']!=null){
									    var Saturday = carpark['Rates']['Saturday'];
										modelText+="<u>Saturday Rates</u><br>";
										for(rate in Saturday){
										    var start = new Date()
											modelText+="Start :"+Saturday[rate]['startHour']+"00 - "+Saturday[rate]['endHour']+"00 (";
											var prices = Saturday[rate]['pricePerHalfHour'];
											//per entry display
											if(prices[1]==0)
											    modelText += "Per Entry:$"+prices[0]+")<br>";
											else{
											    //1St Hour and subsequent Hour
											    if(prices.length>2){
											       var prev = prices[0];
													for(var i=1;i<prices.length;i++){
														if(prices[i]!=prev){
															modelText += "Price 1st h: $"+prev*2;
															prev = prices[i];
														}
													}
													modelText += " Subsequent 1/2 h: $"+prev+")<br>";
												}
											    else{
													modelText += " Price per 1/2 h: $"+prices[0]+")<br>";
												}
											}
										}
									}
									//There is a Saturday Rate
									if(carpark['Rates']['Sunday']!=null){
									    var Sunday = carpark['Rates']['Sunday'];
										modelText+="<u>Sunday Rates</u><br>";
										for(rate in Sunday){
										    var start = new Date()
											modelText+="Start :"+Sunday[rate]['startHour']+"00 - "+Sunday[rate]['endHour']+"00 (";
											var prices = Sunday[rate]['pricePerHalfHour'];
											//per entry display
											if(prices[1]==0)
											    modelText += "Per Entry:$"+prices[0]+")<br>";
											else{
											    //1St Hour and subsequent Hour
											    if(prices.length>2){
											       var prev = prices[0];
													for(var i=1;i<prices.length;i++){
														if(prices[i]!=prev){
															modelText += "Price 1st h: $"+prev*2;
															prev = prices[i];
														}
													}
													modelText += " Subsequent 1/2 h: $"+prev+")<br>";
												}
											    else{
													modelText += " Price per 1/2 h: $"+prices[0]+")<br>";
												}
											}
										}
									}
								modelText+='</div>' +
							'</div>' +
						'</div>';
					myApp.pickerModal(modelText);
				});
				// Create a marker for each place.
				markers.push(marker);
			}
    	}

		searchBox.addListener('places_changed', function() {
			var places = searchBox.getPlaces();

			if (places.length == 0) {
				return;
			}


			// For each place, get the icon, name and location.
			var bounds = new google.maps.LatLngBounds();
			places.forEach(function(place) {
				if (!place.geometry) {
					console.log("Returned place contains no geometry");
					return;
				}
				var icon = {
					url: place.icon,
					size: new google.maps.Size(71, 71),
					origin: new google.maps.Point(0, 0),
					anchor: new google.maps.Point(17, 34),
					scaledSize: new google.maps.Size(25, 25)
				};

				if (place.geometry.viewport) {
					// Only geocodes have viewport.
					bounds.union(place.geometry.viewport);
				} else {
					bounds.extend(place.geometry.location);
				}
			});
			map.setZoom(15);
			map.fitBounds(bounds);
		});
    }

    $(document).ready(function(){

    });
    // Bias the autocomplete object to the user's geographical location,
    // as supplied by the browser's 'navigator.geolocation' object.
    function geolocate() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var geolocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                map.setCenter(geolocation);
                map.setZoom(17);
                var circle = new google.maps.Circle({
                    center: geolocation,
                    radius: position.coords.accuracy
                });
            });
        }
    }

    function route(){
        var start = document.getElementById('source').value;
        var destination = document.getElementById('destination').value;
        console.log(start+"  "+destination);
        $('#clearBtn').toggle();
        var request = {
            origin:start,
            destination:destination,
            travelMode: 'DRIVING'
        };
        directionsService.route(request, function(response, status) {
            if (status == 'OK') {
                console.log("here");
                directionsDisplay.setDirections(response);
            }
        });
    }

    function resetRoute(){
        directionsDisplay.setMap(null);
        $('#clearBtn').toggle();
    }

    //For RecordCPInfo

    document.getElementById('testingsearch').innerHTML="";
    //console.log(json);
    console.log("hrllo");
    for (place in json) {
        var li = document.createElement('li');
        li.className="item-content";

        var div2 = document.createElement('div');
        div2.className = "item-title";


        var a1 = document.createElement('a');
        a1.href="#index";
        a1.className="back";
        a1.id=place;
        a1.onclick=function(){
            document.getElementById('xferback').innerHTML = this.id;
        };
        a1.appendChild(document.createTextNode(place));
        //console.log(a1);
        div2.appendChild(a1);

        li.appendChild(div2);

        //li.appendChild(document.createTextNode(prediction.description));
        document.getElementById('testingsearch').appendChild(li);

    }

    function initService() {

        document.getElementById('testingsearch').innerHTML="";


        var displaySuggestions = function(predictions, status) {
            if (status != google.maps.places.PlacesServiceStatus.OK) {
                alert(status);
                return;
            }

            predictions.forEach(function(prediction) {
                var li = document.createElement('li');
                li.className="item-content";


                var div2 = document.createElement('div');
                div2.className = "item-title";


                var a1 = document.createElement('a');
                a1.href="#index";
                a1.className="back";
                a1.onclick=function(){ document.getElementById('xferback').innerHTML = prediction.description };
                a1.appendChild(document.createTextNode(prediction.description));

                div2.appendChild(a1);

                li.appendChild(div2);

                //li.appendChild(document.createTextNode(prediction.description));
                document.getElementById('testingsearch').appendChild(li);
            });
            for (smth in json) {
                var li = document.createElement('li');
                li.className="item-content";
                var itemsel = smth;
                var div2 = document.createElement('div');
                div2.className = "item-title";


                var a1 = document.createElement('a');
                a1.href="#index";
                a1.className="back";
                a1.onclick=function(){ document.getElementById('xferback').innerHTML = itemsel };
                a1.appendChild(document.createTextNode(itemsel));

                div2.appendChild(a1);

                li.appendChild(div2);

                console.log(a1);

                //li.appendChild(document.createTextNode(prediction.description));
                document.getElementById('testingsearch').appendChild(li);
            }
        };

        var service = new google.maps.places.AutocompleteService();
        service.getQueryPredictions({ input: document.getElementById("searchform").value }, displaySuggestions);

        //console.log(document.getElementById("searchform").value);
    }
    var countDownDate;
    function starttimer()
    {
        // Set the date we're counting down to
        countDownDate = new Date().getTime();

        // Update the count down every 1 second
        var x = setInterval(function() {

            // Get todays date and time
            var now = new Date().getTime();

            // Find the distance between now an the count down date
            var distance =  now - countDownDate;

            // Time calculations for , hours, minutes and seconds
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);


            document.getElementById("timer").innerHTML = ("0" + hours).slice(-2) + "h:" + ("0" + minutes).slice(-2) + "m:" + ("0" + seconds).slice(-2)+"s";

            // change the price
            document.getElementById("fee").innerHTML = "$"+((hours*60*60)+(minutes*60)+seconds)/100;

        }, 1000);
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDacnVEtNIWnbMCw_QI94kynm0_ytIalQ&libraries=places&callback=initMap"
		async defer></script>
</body>
</html>